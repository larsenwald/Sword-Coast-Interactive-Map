<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Faerûn Map - Enhanced Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Habibi&display=swap"
      rel="stylesheet"
    />
    <script src="https://kit.fontawesome.com/6bbc25d724.js" crossorigin="anonymous"></script>
    <style>
      :root{
        --map-width: 50vw;   /* set whatever you like: 100%, 70vw, etc. */
        --map-height: 60vh;  /* 60vh, clamp(400px,50vh,800px)… */
      }

      /* Reset and base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      .map-wrapper{
      width:  var(--map-width);
      height: var(--map-height);
      position: relative;
      overflow: hidden;         /* keeps tiles inside the frame */
      border: 3px solid #927c5b;/* optional – just to show the edge */
    }

      body {
        font-family: "Habibi", serif;
        background-color: #0c0c0c;
        color: #d8c9a7;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        touch-action: none; /* Disable browser handling of all panning and zooming gestures */
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      /* Map container with fantasy background */
      .map-container {
        position: relative;
        width: 100%;   /* stretch to wrapper */
        height: 100%;  /* stretch to wrapper */
        overflow: hidden;
        background-color:#0c0c0c;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23121212"/><path d="M0 0L100 100M100 0L0 100" stroke="%23181818" stroke-width="0.5"/></svg>');
        background-repeat: repeat;
        touch-action: none; /* Disable browser handling of all panning and zooming gestures */
      }

      /* Map canvas */
      .map-canvas {
        position: absolute;
        cursor: move;
        transform-origin: 0 0;
        will-change: transform;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        touch-action: none; /* Disable browser handling of all panning and zooming gestures */
      }

      /* Map tiles container */
      .tiles-container {
        position: relative;
        transform-origin: 0 0;
        touch-action: none; /* Disable browser handling of all panning and zooming gestures */
      }

      /* Individual map tile */
      .map-tile {
        position: absolute;
        display: block;
        background-size: 100% 100%;
      }

      /* Map markers - now using marker size config */
      .map-marker {
        position: absolute;
        cursor: pointer;
        transition: transform 0.3s ease, filter 0.3s ease;
        filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.9));
        z-index: 10;
        /* Marker size is now managed via JavaScript */
      }

      .map-marker:hover {
        transform: scale(1.3);
        z-index: 20;
        filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
      }

      /* Marker colors and custom SVGs for different types */
      .marker-city {
        color: #e74c3c;
      }
      .marker-town {
        color: #3498db;
      }
      .marker-landmark {
        color: #f1c40f;
      }
      .marker-poi {
        color: #2ecc71;
      }

      /* Beautiful Fantasy Modal Styles */
      .location-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 90%;
        max-width: 650px;
        max-height: 85vh;
        background-color: #28231d;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect width="200" height="200" fill="%2328231d"/><path d="M0,0 L200,200 M200,0 L0,200" stroke="%23352e26" stroke-width="1"/></svg>');
        border: 3px solid #935e27;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7),
          inset 0 0 15px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        /* The following line prevents events from reaching elements beneath the modal */
        isolation: isolate;
      }

      .location-modal.visible {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
      }

      /* Modal header */
      .modal-header {
        position: relative;
        padding: 20px 25px;
        background: linear-gradient(
          to bottom,
          rgba(147, 94, 39, 0.5),
          rgba(104, 65, 25, 0.5)
        );
        border-bottom: 2px solid #935e27;
      }

      .modal-title {
        font-family: "Cinzel", serif;
        font-weight: 700;
        font-size: 26px;
        color: #f8dca0;
        text-align: center;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      .modal-subtitle {
        font-family: "Habibi", serif;
        font-size: 16px;
        color: #d4bc8c;
        text-align: center;
        font-style: italic;
      }

      .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 30px;
        height: 30px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #935e27;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #f0e6d2;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .modal-close:hover {
        background: rgba(147, 94, 39, 0.6);
        transform: scale(1.1);
      }

      /* Modal tabs */
      .modal-tabs {
        display: flex;
        border-bottom: 2px solid #935e27;
        background-color: rgba(40, 35, 29, 0.9);
      }

      .modal-tab {
        flex: 1;
        padding: 12px 5px;
        text-align: center;
        font-family: "Cinzel", serif;
        font-size: 15px;
        color: #d4bc8c;
        cursor: pointer;
        transition: all 0.3s;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
      }

      .modal-tab:hover {
        background-color: rgba(147, 94, 39, 0.2);
      }

      .modal-tab.active {
        color: #f8dca0;
        border-bottom: 2px solid #935e27;
        background-color: rgba(147, 94, 39, 0.3);
      }

      /* Modal content */
      .modal-content {
        max-height: calc(85vh - 190px);
        overflow-y: auto;
        padding: 0;
        scrollbar-width: thin;
        scrollbar-color: #935e27 #28231d;
        z-index: 1100; /* Ensure modal content is above the map for scrolling */
      }

      .modal-content::-webkit-scrollbar {
        width: 8px;
      }

      .modal-content::-webkit-scrollbar-thumb {
        background-color: #935e27;
        border-radius: 4px;
      }

      .modal-content::-webkit-scrollbar-track {
        background-color: #28231d;
      }

      .tab-content {
        display: none;
        padding: 25px;
      }

      .tab-content.active {
        display: block;
      }

      .tab-content p {
        color: #e9d9b6;
        line-height: 1.7;
        margin-bottom: 15px;
      }

      .tab-content h3 {
        font-family: "Cinzel", serif;
        font-size: 20px;
        color: #f8dca0;
        margin: 15px 0 10px;
        border-bottom: 1px solid rgba(147, 94, 39, 0.5);
        padding-bottom: 5px;
      }

      .tab-content ul {
        margin-left: 20px;
        margin-bottom: 15px;
      }

      .tab-content li {
        margin-bottom: 8px;
        line-height: 1.5;
      }

      /* Image in lore tab */
      .location-image {
        width: 100%;
        height: 0;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        margin-bottom: 15px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 6px;
        border: 2px solid #935e27;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
        position: relative;
        overflow: hidden;
      }

      /* For images with specific aspect ratios that should be preserved */
      .location-image.preserve-ratio {
        background-size: contain;
        background-color: rgba(0, 0, 0, 0.3);
      }

      /* Responsive adjustments for location images on different screen sizes */
      @media (max-width: 768px) {
        .location-image {
          padding-bottom: 75%; /* 4:3 aspect ratio on smaller screens */
        }
      }

      @media (max-width: 480px) {
        .location-image {
          padding-bottom: 75%; /* Keep 4:3 on mobile */
          margin-bottom: 10px;
          border-width: 1px;
        }
      }

      /* Notable NPCs styling */
      .npc-list {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
      }

      .npc-card {
        flex: 1 0 calc(50% - 15px);
        min-width: 200px;
        background: rgba(40, 35, 29, 0.7);
        border: 1px solid #935e27;
        border-radius: 6px;
        padding: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .npc-name {
        font-family: "Cinzel", serif;
        font-size: 17px;
        color: #f8dca0;
        margin-bottom: 5px;
      }

      .npc-title {
        font-style: italic;
        font-size: 14px;
        color: #d4bc8c;
        margin-bottom: 8px;
      }

      .npc-description {
        font-size: 14px;
        line-height: 1.5;
      }

      /* Quests tab styling */
      .quest-item {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(147, 94, 39, 0.3);
      }

      .quest-title {
        font-family: "Cinzel", serif;
        font-size: 18px;
        color: #f8dca0;
        margin-bottom: 5px;
      }

      .quest-difficulty {
        display: inline-block;
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 10px;
        margin-bottom: 8px;
      }

      .quest-difficulty.easy {
        background-color: rgba(46, 204, 113, 0.3);
        border: 1px solid #2ecc71;
      }

      .quest-difficulty.medium {
        background-color: rgba(241, 196, 15, 0.3);
        border: 1px solid #f1c40f;
      }

      .quest-difficulty.hard {
        background-color: rgba(231, 76, 60, 0.3);
        border: 1px solid #e74c3c;
      }

      .quest-description {
        line-height: 1.6;
      }

      /* Modal backdrop */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(3px);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        /* The following line prevents events from reaching elements beneath the backdrop */
        isolation: isolate;
      }

      .modal-backdrop.visible {
        opacity: 1;
        visibility: visible;
      }

      /* Dressing for the modal */
      .modal-corner {
        position: absolute;
        width: 30px;
        height: 30px;
        pointer-events: none;
      }

      .modal-corner.top-left {
        top: 0;
        left: 0;
        border-top: 3px solid #935e27;
        border-left: 3px solid #935e27;
      }

      .modal-corner.top-right {
        top: 0;
        right: 0;
        border-top: 3px solid #935e27;
        border-right: 3px solid #935e27;
      }

      .modal-corner.bottom-left {
        bottom: 0;
        left: 0;
        border-bottom: 3px solid #935e27;
        border-left: 3px solid #935e27;
      }

      .modal-corner.bottom-right {
        bottom: 0;
        right: 0;
        border-bottom: 3px solid #935e27;
        border-right: 3px solid #935e27;
      }

      /* Controls */

      .control-panel {
        position: absolute;
        bottom: 0;
        right: 0;
        display: flex;
        gap: 2%;
      }

      .control-btn {
        width: 45px;
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background-color: #3d3224;
        color: #f0e6d2;
        border: 2px solid #927c5b;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-family: "Cinzel", serif;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3),
          inset 0 1px 2px rgba(255, 255, 255, 0.2);
      }

      .control-btn:hover {
        background-color: #524533;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4),
          inset 0 1px 3px rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .control-btn:active {
        background-color: #2d261c;
        transform: translateY(1px);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3),
          inset 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      /* Loading indicator */
      .loading-indicator {
        position: absolute;
        top: 0;
        right: 0;
        padding: 8px 12px;
        background-color: rgba(0, 0, 0, 0.7);
        color: #f0e6d2;
        border-radius: 6px;
        font-size: 14px;
        text-align: center;
        font-family: "Habibi", serif;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        border: 1px solid #927c5b;
      }

      /* Loading animation */
      .loading-indicator::after {
        content: "";
        display: inline-block;
        width: 12px;
        animation: loadingDots 1.5s infinite;
      }

      @keyframes loadingDots {
        0% {
          content: ".";
        }
        33% {
          content: "..";
        }
        66% {
          content: "...";
        }
      }

      /* Debug info */
      .debug-info {
        position: fixed;
        bottom: 15px;
        left: 15px;
        background-color: rgba(0, 0, 0, 0.7);
        color: #f0e6d2;
        font-size: 12px;
        padding: 8px 12px;
        border-radius: 6px;
        z-index: 50;
        border: 1px solid #927c5b;
        font-family: "Habibi", serif;
      }

      /* Legend panel */
      .map-legend {
        position: absolute;
        bottom: 1%;
        left: 1%;
        background-color: rgba(93, 76, 54, 0.85);
        border: 3px solid #927c5b;
        border-radius: 10px;
        padding: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5),
          inset 0 0 10px rgba(0, 0, 0, 0.2);
        color: #f0e6d2;
        max-width: 250px;
        user-select: none;
        cursor: pointer;
        transition: transform .1s;
      }
      .map-legend:hover{
        transform: scale(1.05)
      }

      .legend-title {
        text-align: center;
        margin-bottom: 10px;
        font-family: "Cinzel", serif;
        font-size: 18px;
        border-bottom: 2px solid #927c5b;
        padding-bottom: 5px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }

      .legend-icon {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .legend-text {
        font-size: 14px;
        font-family: "Habibi", serif;
      }

      #expand-legend{
        position: absolute;
        bottom: 0;
        left: 0;
      }

      .hidden{
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="map-wrapper">
      <div class="map-container" id="map-container">
        <div class="map-canvas" id="map-canvas">
          <div class="tiles-container" id="tiles-container">
            <!-- Tiles will be generated here -->
          </div>
          <!-- Markers will be generated here -->
        </div>
        </div>
        <!-- Beautiful Location Modal -->
        <div class="modal-backdrop" id="modal-backdrop"></div>
        <div class="location-modal" id="location-modal">
          <div class="modal-corner top-left"></div>
          <div class="modal-corner top-right"></div>
          <div class="modal-corner bottom-left"></div>
          <div class="modal-corner bottom-right"></div>
          <div class="modal-header">
            <h2 class="modal-title" id="modal-title">Location Name</h2>
            <div class="modal-subtitle" id="modal-subtitle">
              Subtitle or location type
            </div>
            <div class="modal-close" id="modal-close">×</div>
          </div>
          <div class="modal-tabs" id="modal-tabs">
            <div class="modal-tab active" data-tab="overview">Overview</div>
            <div class="modal-tab" data-tab="lore">Lore & History</div>
            <div class="modal-tab" data-tab="npcs">Notable NPCs</div>
          </div>
          <div class="modal-content" id="modal-content">
            <!-- Tab contents will be populated dynamically -->
            <div class="tab-content active" id="tab-overview">
              <!-- Overview content will be inserted here -->
            </div>
            <div class="tab-content" id="tab-lore">
              <!-- Lore content will be inserted here -->
            </div>
            <div class="tab-content" id="tab-npcs">
              <!-- NPCs content will be inserted here -->
            </div>
          </div>
        </div>
        <!-- Legend for map markers -->
        <div class="map-legend">
          <div class="legend-title">Map Symbols</div>
          <div class="legend-item">
            <div class="legend-icon marker-city">
              <!-- City icon will be inserted by JavaScript -->
            </div>
            <div class="legend-text">Major City</div>
          </div>
          <div class="legend-item">
            <div class="legend-icon marker-town">
              <!-- Town icon will be inserted by JavaScript -->
            </div>
            <div class="legend-text">Town</div>
          </div>
          <div class="legend-item">
            <div class="legend-icon marker-landmark">
              <!-- Landmark icon will be inserted by JavaScript -->
            </div>
            <div class="legend-text">Landmark</div>
          </div>
          <div class="legend-item">
            <div class="legend-icon marker-poi">
              <!-- POI icon will be inserted by JavaScript -->
            </div>
            <div class="legend-text">Point of Interest</div>
          </div>
        </div>
        <div id="expand-legend" class="hidden control-btn"><i class="fa-solid fa-caret-up"></i></div>
        <div class="map-controls">
          <div class="control-panel">
              <button class="control-btn" id="zoom-in">+</button>
              <button class="control-btn" id="zoom-out">−</button>
            <button class="control-btn" id="reset-view">
              ⟲
            </button>
          </div>
        </div>
        <div
            class="loading-indicator"
            id="loading-indicator"
            style="display: none"
          >
            Loading tiles
          </div>
        <div class="debug-info" id="debug-info" style="display: none">
          Zoom: 1.0, Tiles: 0/0 loaded
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Map elements
        const mapContainer = document.getElementById("map-container");
        const mapCanvas = document.getElementById("map-canvas");
        const tilesContainer = document.getElementById("tiles-container");

        // Control elements
        const zoomInBtn = document.getElementById("zoom-in");
        const zoomOutBtn = document.getElementById("zoom-out");
        const resetViewBtn = document.getElementById("reset-view");
        const loadingIndicator = document.getElementById("loading-indicator");
        const debugInfo = document.getElementById("debug-info");

        // Modal elements
        const modalBackdrop = document.getElementById("modal-backdrop");
        const locationModal = document.getElementById("location-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalSubtitle = document.getElementById("modal-subtitle");
        const modalClose = document.getElementById("modal-close");
        const modalTabs = document.getElementById("modal-tabs");
        const tabContents = document.querySelectorAll(".tab-content");

        // Map state variables
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let startPanX = 0;
        let startPanY = 0;
        let isPanning = false;
        let lastMouseX = 0;
        let lastMouseY = 0;

        // Tile management variables
        let tileSize = 256; // Size of each tile in pixels
        let tilesX = 0; // Number of tiles in X direction
        let tilesY = 0; // Number of tiles in Y direction
        let loadedTiles = 0;
        let totalVisibleTiles = 0;
        let visibleTiles = new Set(); // Keep track of which tiles are in view
        let tilesLoading = new Set(); // Keep track of tiles currently loading

        // Original image dimensions
        // Change these to match your actual image dimensions
        const originalWidth = 10200;
        const originalHeight = 6600;

        // Min and max zoom levels
        const MIN_SCALE = 0.1;
        const MAX_SCALE = 3;

        // Initial zoom settings
        const initialScale = 0.6; // Initial zoom level - increase for closer zoom
        const initialX = 0.42; // X position to center on (0-1, percentage of image width)
        const initialY = 0.24; // Y position to center on (0-1, percentage of image height)

        // ==========================================
        // MARKER SIZE CONFIGURATION - EASILY ADJUSTABLE
        // ==========================================
        const markerSizes = {
          city: {
            width: 40, // Width in pixels
            height: 40, // Height in pixels
            offsetX: -20, // Horizontal offset from location point (half width)
            offsetY: -40, // Vertical offset from location point
          },
          town: {
            width: 32,
            height: 32,
            offsetX: -16,
            offsetY: -32,
          },
          landmark: {
            width: 36,
            height: 36,
            offsetX: -18,
            offsetY: -36,
          },
          poi: {
            width: 28,
            height: 28,
            offsetX: -14,
            offsetY: -28,
          },
        };

        // ==========================================
        // NEW FANTASY MARKER ICONS
        // ==========================================
        const markerSVGs = {
          city: `<svg viewBox="0 0 24 24" width="100%" height="100%" fill="currentColor">
                  <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 4c1.6 0 3 1.3 3 3s-1.4 3-3 3-3-1.3-3-3 1.4-3 3-3zm0 9.6c-2.3 0-4.3-1.2-5.5-3 .3-1.8 3.7-2.8 5.5-2.8s5.2 1 5.5 2.8c-1.2 1.8-3.2 3-5.5 3z"/>
                </svg>`,
          town: `<svg viewBox="0 0 24 24" width="100%" height="100%" fill="currentColor">
                  <path d="M15 11V5l-3-3-3 3v2H3v14h18V11h-6zm-8 8H5v-2h2v2zm0-4H5v-2h2v2zm0-4H5V9h2v2zm6 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V9h2v2zm0-4h-2V5h2v2zm6 12h-2v-2h2v2zm0-4h-2v-2h2v2z"/>
                </svg>`,
          landmark: `<svg viewBox="0 0 24 24" width="100%" height="100%" fill="currentColor">
                      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm-1.5 9.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm3-3c-.83 0-1.5-.67-1.5-1.5S12.67 5.5 13.5 5.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm-3-3C10.67 5.5 10 4.83 10 4s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                    </svg>`,
          poi: `<svg viewBox="0 0 24 24" width="100%" height="100%" fill="currentColor">
                 <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
               </svg>`,
        };

        // ==========================================
        // EXPANDED SAMPLE LOCATIONS DATA
        // ==========================================
        const locations = [
          {
            id: 1,
            name: "Neverwinter",
            type: "city",
            subtitle: "The Jewel of the North",
            description:
              "A bustling coastal city famous for its hot springs that keep the city warm despite its northern latitude.",
            x: originalWidth * 0.3985,
            y: originalHeight * 0.207,
            details: {
              overview: `<div class="location-image" style="background-image: url('NeverwinterHarbor.webp');"></div>
                        <p>Neverwinter, known as the City of Skilled Hands and the Jewel of the North, stands as one of the most prosperous cities in northern Faerûn. Despite its northern location, the city is warmed year-round by hot springs that flow from Mount Hotenow, keeping the port ice-free and earning the city its name.</p>
                        <p>The city is divided into several districts, including the City Core, Blacklake District, Docks District, and Beggar's Nest. Each area has its own character and offers different services to visitors.</p>
                        <h3>Notable Features</h3>
                        <ul>
                          <li>The Neverwinter River runs through the center of the city</li>
                          <li>Castle Never stands as the seat of governance</li>
                          <li>The Hall of Justice serves as the temple to Tyr</li>
                          <li>The Moonstone Mask provides high-class accommodation</li>
                        </ul>
                        <p>The city is currently governed by Lord Neverember, who has undertaken significant reconstruction efforts following the cataclysm that damaged much of the city.</p>`,
              lore: `<p>Neverwinter was founded in 87 DR by Lord Halueth Never. For much of its history, the city was ruled by the Lords of Neverwinter, descendants of the Never line.</p>
                     <p>In the Year of Blue Fire (1385 DR), the Spellplague struck Toril. While Neverwinter was spared the worst effects, decades later Mount Hotenow erupted in the Year of Knowledge Unearthed (1451 DR), destroying much of the city.</p>
                     <h3>Recent History</h3>
                     <p>Lord Dagult Neverember, Open Lord of Waterdeep, came to Neverwinter claiming to be a descendant of Neverwinter's former rulers and began recruiting mercenaries to help rebuild the city and establish order.</p>
                     <p>In recent years, Neverwinter has seen a steady influx of settlers and merchants, drawn by Lord Neverember's promise of wealth and prosperity. The city continues to rebuild, though several districts remain in ruins.</p>`,
              npcs: `<div class="npc-list">
                      <div class="npc-card">
                        <div class="npc-name">Lord Dagult Neverember</div>
                        <div class="npc-title">Lord Protector of Neverwinter</div>
                        <div class="npc-description">A charismatic and ambitious politician who claims distant relation to the original Never family. He divides his time between Neverwinter and Waterdeep.</div>
                      </div>
                      <div class="npc-card">
                        <div class="npc-name">Soman Galt</div>
                        <div class="npc-title">Captain of the Neverwinter Guard</div>
                        <div class="npc-description">A stern but fair former mercenary who enforces law and order within the city walls.</div>
                      </div>
                      <div class="npc-card">
                        <div class="npc-name">Jasper Dimmerling</div>
                        <div class="npc-title">Guildmaster of Traders</div>
                        <div class="npc-description">A shrewd halfling merchant who oversees commerce in the city and maintains good relations with trading partners along the Sword Coast.</div>
                      </div>
                      <div class="npc-card">
                        <div class="npc-name">Ophala Cheldarstorn</div>
                        <div class="npc-title">Proprietor of the Moonstone Mask</div>
                        <div class="npc-description">A former adventurer who now runs the most luxurious festhall in Neverwinter, which serves as a neutral ground for political meetings.</div>
                      </div>
                    </div>`,
            },
          },
          {
            id: 2,
            name: "Waterdeep",
            type: "city",
            subtitle: "The City of Splendors",
            description:
              "The largest and most influential city on the Sword Coast, known for its cosmopolitan culture and powerful noble families.",
            x: originalWidth * 0.4518,
            y: originalHeight * 0.372,
            details: {
              overview: `<div class="location-image" style="background-image: url('https://uploads.worldanvil.com/uploads/images/cc12e4c325273cde196cd9a80666f18b.webp');"></div>
                        <p>Waterdeep, the City of Splendors, is the most influential and important city in the North and perhaps in all Faerûn. Home to as many as 2 million people, it is a truly cosmopolitan city where all races and cultures can be found.</p>
                        <p>The city is divided into several wards including Castle Ward, Dock Ward, Field Ward, North Ward, Sea Ward, Southern Ward, and Trades Ward. Each has its own character, from the wealth of Sea Ward to the bustling commerce of Trades Ward.</p>
                        <h3>Notable Features</h3>
                        <ul>
                          <li>Mount Waterdeep, upon which stands Waterdeep Castle</li>
                          <li>The Walking Statues, enormous stone constructs that defend the city</li>
                          <li>Blackstaff Tower, home to the Archmage of Waterdeep</li>
                          <li>The Yawning Portal Inn, entrance to the infamous Undermountain dungeon</li>
                        </ul>
                        <p>The city is governed by a council of masked Lords and the Open Lord of Waterdeep, currently Laeral Silverhand.</p>`,
              lore: `
                     <p>Waterdeep was founded in approximately -1000 DR as a trading post where northern tribesmen met merchants from the south. By 52 DR, it had grown into a fortified city named "Nimoar's Hold" after its warlord.</p>
                     <p>The name "Waterdeep" began to be used around 1032 DR, referring to the deep harbor. The city continued to grow in size and influence, eventually becoming the most powerful city in the North.</p>
                     <h3>Recent History</h3>
                     <p>In recent decades, Waterdeep has weathered many challenges including the Spellplague, the rise and fall of the Shadovar, and conflicts with the Cult of the Dragon.</p>
                     <p>Currently, the city thrives under the leadership of Laeral Silverhand, who took over as Open Lord after the abdication of Dagult Neverember.</p>`,
              npcs: `<div class="npc-list">
                      <div class="npc-card">
                        <div class="npc-name">Laeral Silverhand</div>
                        <div class="npc-title">Open Lord of Waterdeep</div>
                        <div class="npc-description">A powerful mage and one of the Seven Sisters, Laeral is the visible ruler of Waterdeep and a wise, if sometimes stern, leader.</div>
                      </div>
                      <div class="npc-card">
                        <div class="npc-name">Vajra Safahr</div>
                        <div class="npc-title">Blackstaff</div>
                        <div class="npc-description">The current Archmage of Waterdeep and wielder of the Blackstaff, Vajra serves as the city's primary magical defender.</div>
                      </div>
                      <div class="npc-card">
                        <div class="npc-name">Mirt</div>
                        <div class="npc-title">The Moneylender</div>
                        <div class="npc-description">A wealthy, rotund man known for his business acumen and surprising fighting skills. He is secretly a Lord of Waterdeep and a Harper agent.</div>
                      </div>
                      <div class="npc-card">
                        <div class="npc-name">Durnan</div>
                        <div class="npc-title">Owner of the Yawning Portal</div>
                        <div class="npc-description">A former adventurer who now runs the famous inn built around the entrance to Undermountain. He knows more about the dungeon than almost anyone else.</div>
                      </div>
                    </div>`,
            },
          },
        ];

        // Performance optimization - check for hardware acceleration
        const hasHardwareAcceleration = (function () {
          const el = document.createElement("div");
          const transforms = {
            webkitTransform: "-webkit-transform",
            OTransform: "-o-transform",
            msTransform: "-ms-transform",
            MozTransform: "-moz-transform",
            transform: "transform",
          };

          for (const t in transforms) {
            if (el.style[t] !== undefined) {
              el.style[t] = "translate3d(1px,1px,1px)";
              const has3d = window
                .getComputedStyle(el)
                .getPropertyValue(transforms[t]);
              return (
                has3d !== undefined && has3d.length > 0 && has3d !== "none"
              );
            }
          }
          return false;
        })();

        // map legend expand/collapse logic:
        document.querySelector(".map-legend").addEventListener("click", function(){
          this.classList.add("hidden")
          document.querySelector("#expand-legend").classList.remove("hidden")
        })

        document.querySelector("#expand-legend").addEventListener("click", function(){
          this.classList.add("hidden")
          document.querySelector(".map-legend").classList.remove("hidden")
        })

        // Update legend icons with the new marker SVGs
        document.querySelectorAll(".legend-icon").forEach((icon) => {
          const type = icon.className.split(" ")[1].replace("marker-", "");
          icon.innerHTML = markerSVGs[type] || markerSVGs.poi;
        });

        // Disable browser pinch zoom
        disableNativePinchZoom();

        // Initialize map
        initMap();

        // Add subtle ambient animation
        addAmbientEffects();

        // Disable browser's native pinch-to-zoom functionality
        function disableNativePinchZoom() {
          // 1. Prevent touchmove with more than one touch (pinch gesture)
          document.addEventListener(
            "touchmove",
            function (e) {
              if (e.touches.length > 1) {
                e.preventDefault();
              }
            },
            { passive: false }
          );

          // 2. Prevent wheel events when ctrl key is pressed (browser zoom)
          document.addEventListener(
            "wheel",
            function (e) {
              if (e.ctrlKey) {
                e.preventDefault();
              }
            },
            { passive: false }
          );

          // 3. Prevent the gesturestart event (Safari)
          document.addEventListener(
            "gesturestart",
            function (e) {
              e.preventDefault();
            },
            { passive: false }
          );

          // 4. Prevent the gesturechange event (Safari)
          document.addEventListener(
            "gesturechange",
            function (e) {
              e.preventDefault();
            },
            { passive: false }
          );

          // 5. Prevent the gestureend event (Safari)
          document.addEventListener(
            "gestureend",
            function (e) {
              e.preventDefault();
            },
            { passive: false }
          );
        }

        // Set initial position and create tiles
        function initMap() {
          // Calculate tiles needed based on your actual tiles
          tilesX = 40; // You have tiles from 0 to 39 in X direction
          tilesY = 26; // You have tiles from 0 to 25 in Y direction

          // Set the tiles container size to match original image
          tilesContainer.style.width = `${originalWidth}px`;
          tilesContainer.style.height = `${originalHeight}px`;

          // Set initial scale
          scale = initialScale;

          // Set initial position to center on the targeted coordinates
          translateX =
            mapContainer.offsetWidth / 2 - originalWidth * initialX * scale;
          translateY =
            mapContainer.offsetHeight / 2 - originalHeight * initialY * scale;

          // Apply initial transform
          updateMapTransform();

          // Create markers for locations
          createMarkers();

          // Initial load of visible tiles
          requestAnimationFrame(updateVisibleTiles);
        }

        // Add subtle ambient animations for immersion
        function addAmbientEffects() {
          // Subtle pulsing effect on the compass rose
          const compassRose = document.querySelector(".compass-rose");
          setInterval(() => {
            compassRose.style.opacity =
              parseFloat(compassRose.style.opacity || 0.8) === 0.8 ? 0.9 : 0.8;
          }, 3000);
        }

        // Create tile elements as needed based on viewport
        function updateVisibleTiles() {
          // Show loading indicator
          loadingIndicator.style.display = "block";

          // Calculate which tiles should be visible
          const viewportRect = mapContainer.getBoundingClientRect();
          const mapRect = {
            left: translateX,
            top: translateY,
            width: originalWidth * scale,
            height: originalHeight * scale,
          };

          // Determine tile boundaries that are in view
          const startTileX = Math.max(
            0,
            Math.floor(-translateX / scale / tileSize)
          );
          const endTileX = Math.min(
            tilesX - 1,
            Math.ceil((-translateX + viewportRect.width) / scale / tileSize)
          );
          const startTileY = Math.max(
            0,
            Math.floor(-translateY / scale / tileSize)
          );
          const endTileY = Math.min(
            tilesY - 1,
            Math.ceil((-translateY + viewportRect.height) / scale / tileSize)
          );

          // Keep track of new visible tiles
          const newVisibleTiles = new Set();

          // Create and position visible tiles
          for (let y = startTileY; y <= endTileY; y++) {
            for (let x = startTileX; x <= endTileX; x++) {
              const tileKey = `tile-${x}-${y}`;
              newVisibleTiles.add(tileKey);

              // Only create tile if it doesn't exist
              if (!visibleTiles.has(tileKey) && !tilesLoading.has(tileKey)) {
                createTile(x, y);
              }
            }
          }

          // Remove tiles that are no longer visible
          visibleTiles.forEach((tileKey) => {
            if (!newVisibleTiles.has(tileKey)) {
              const tileElement = document.getElementById(tileKey);
              if (tileElement) {
                tileElement.remove();
              }
              visibleTiles.delete(tileKey);
            }
          });

          // Update visible tiles set
          visibleTiles = newVisibleTiles;
          totalVisibleTiles = visibleTiles.size;

          // Update debug info
          updateDebugInfo();

          // Hide loading indicator if no tiles are loading
          if (tilesLoading.size === 0) {
            loadingIndicator.style.display = "none";
          }
        }

        // Create a single tile
        function createTile(x, y) {
          const tileKey = `tile-${x}-${y}`;

          // Add to loading set
          tilesLoading.add(tileKey);

          // Create tile element
          const tile = document.createElement("div");
          tile.id = tileKey;
          tile.className = "map-tile";
          tile.style.width = `${tileSize}px`;
          tile.style.height = `${tileSize}px`;
          tile.style.left = `${x * tileSize}px`;
          tile.style.top = `${y * tileSize}px`;

          // Add error handling for tiles
          tile.onerror = function () {
            console.error(`Failed to load tile: ${tileKey}`);
            // Set a fallback background color
            tile.style.backgroundColor = "#1c1c1c";
            tilesLoading.delete(tileKey);

            // Still count it as loaded for the UI
            loadedTiles++;
            updateDebugInfo();
          };

          // Load your actual tile images
          tile.style.backgroundImage = `url('faerun_tiles/tile_${y}_${x}.png')`;

          // Add to DOM
          tilesContainer.appendChild(tile);

          // Add to visible tiles
          visibleTiles.add(tileKey);

          // Add load event for the tile
          const img = new Image();
          img.onload = function () {
            tilesLoading.delete(tileKey);
            loadedTiles++;
            updateDebugInfo();

            // Hide loading indicator if all tiles loaded
            if (tilesLoading.size === 0) {
              loadingIndicator.style.display = "none";
            }
          };

          // Set the image source to start loading
          img.src = `faerun_tiles/tile_${y}_${x}.png`;
        }

        // Create SVG markers for all locations using the new marker system
        function createMarkers() {
          locations.forEach((location) => {
            // Create marker element
            const marker = document.createElement("div");
            marker.className = `map-marker marker-${location.type}`;
            marker.dataset.id = location.id;

            // Get the marker configuration for this type
            const markerConfig = markerSizes[location.type] || markerSizes.poi;

            // Set marker size and position using the configuration
            marker.style.width = `${markerConfig.width}px`;
            marker.style.height = `${markerConfig.height}px`;
            marker.style.marginLeft = `${markerConfig.offsetX}px`;
            marker.style.marginTop = `${markerConfig.offsetY}px`;

            // Add the appropriate SVG icon based on location type
            marker.innerHTML = markerSVGs[location.type] || markerSVGs.poi;

            // Position marker on the map
            marker.style.left = `${location.x}px`;
            marker.style.top = `${location.y}px`;

            // Add event listeners
            marker.addEventListener("click", function (e) {
              showLocationModal(location);
              e.stopPropagation();
            });

            // Add marker to map
            mapCanvas.appendChild(marker);
          });
        }

        // Show the modal with location information
        function showLocationModal(location) {
          // Update modal content
          modalTitle.textContent = location.name;
          modalSubtitle.textContent =
            location.subtitle ||
            location.type.charAt(0).toUpperCase() + location.type.slice(1);

          // Update tab contents
          document.getElementById("tab-overview").innerHTML =
            location.details.overview || "<p>No overview available.</p>";
          document.getElementById("tab-lore").innerHTML =
            location.details.lore || "<p>No lore available.</p>";
          document.getElementById("tab-npcs").innerHTML =
            location.details.npcs || "<p>No notable NPCs.</p>";

          // Show modal with animation
          modalBackdrop.classList.add("visible");
          setTimeout(() => {
            locationModal.classList.add("visible");
          }, 10);

          // Reset to first tab
          activateTab("overview");
        }

        // Activate a specific tab
        function activateTab(tabId) {
          // Deactivate all tabs
          document.querySelectorAll(".modal-tab").forEach((tab) => {
            tab.classList.remove("active");
          });
          document.querySelectorAll(".tab-content").forEach((content) => {
            content.classList.remove("active");
          });

          // Activate selected tab
          document
            .querySelector(`.modal-tab[data-tab="${tabId}"]`)
            .classList.add("active");
          document.getElementById(`tab-${tabId}`).classList.add("active");
        }

        // Tab switching logic
        modalTabs.addEventListener("click", function (e) {
          if (e.target.classList.contains("modal-tab")) {
            activateTab(e.target.dataset.tab);
          }
        });

        // Close modal
        modalClose.addEventListener("click", function () {
          locationModal.classList.remove("visible");
          setTimeout(() => {
            modalBackdrop.classList.remove("visible");
            // Re-enable map interactions when modal is closed
            document.body.style.overflow = "";
          }, 300);
        });

        // Close modal when clicking on backdrop
        modalBackdrop.addEventListener("click", function () {
          locationModal.classList.remove("visible");
          setTimeout(() => {
            modalBackdrop.classList.remove("visible");
            // Re-enable map interactions when modal is closed
            document.body.style.overflow = "";
          }, 300);
        });

        // Pan functionality
        mapCanvas.addEventListener("mousedown", startPan);
        document.addEventListener("mousemove", throttle(pan, 16)); // ~60fps
        document.addEventListener("mouseup", endPan);
        document.addEventListener("click", handleClick);

        // Touch support
        mapCanvas.addEventListener("touchstart", startPanTouch);
        document.addEventListener("touchmove", throttle(panTouch, 16)); // ~60fps
        document.addEventListener("touchend", endPan);

        // Edge case handlers
        window.addEventListener("mouseleave", endPan);
        window.addEventListener("blur", endPan);

        // Zoom controls
        zoomInBtn.addEventListener("click", zoomIn);
        zoomOutBtn.addEventListener("click", zoomOut);
        resetViewBtn.addEventListener("click", resetView);

        // Handle mouse wheel zoom ONLY - disable touchpad pinch zoom
        mapContainer.addEventListener(
          "wheel",
          function (e) {
            // Check if we're inside the modal content - if so, allow normal scrolling
            if (
              modalBackdrop.classList.contains("visible") &&
              (e.target.closest(".modal-content") ||
                e.target.closest(".tab-content"))
            ) {
              // Allow default scrolling behavior in modal content
              return true;
            }

            // Otherwise handle map zooming (for the map itself)
            // Only allow non-ctrl wheel events (prevent browser zoom)
            if (!e.ctrlKey) {
              handleZoom(e);
            }
            // Always prevent default to disable any native zooming
            e.preventDefault();
          },
          { passive: false }
        );

        // Mouse wheel zoom handler
        function handleZoom(e) {
          // Get position within the map container
          const containerRect = mapContainer.getBoundingClientRect();
          const mouseX = e.clientX - containerRect.left;
          const mouseY = e.clientY - containerRect.top;

          // Calculate position on the map
          const mapX = (mouseX - translateX) / scale;
          const mapY = (mouseY - translateY) / scale;

          // Determine zoom direction and use a smaller factor for smoother zooming
          const zoomFactor = e.deltaY < 0 ? 1.05 : 0.95;

          // Apply zoom with limits
          const newScale = Math.max(
            MIN_SCALE,
            Math.min(MAX_SCALE, scale * zoomFactor)
          );

          // Only update if scale actually changed
          if (newScale !== scale) {
            // Apply zoom around mouse position
            scale = newScale;
            translateX = mouseX - mapX * scale;
            translateY = mouseY - mapY * scale;

            // Update transform
            requestAnimationFrame(() => {
              updateMapTransform();
              // Update visible tiles after zoom
              updateVisibleTiles();
            });
          }
        }

        // Start panning
        function startPan(e) {
          // Only start panning with left mouse button
          if (e.button !== 0) return;

          isPanning = true;
          startPanX = e.clientX - translateX;
          startPanY = e.clientY - translateY;

          // Store initial mouse position
          lastMouseX = e.clientX;
          lastMouseY = e.clientY;

          mapCanvas.style.cursor = "grabbing";
          e.preventDefault(); // Prevent text selection
        }

        // Start panning (touch)
        function startPanTouch(e) {
          // Only handle single-touch events for panning
          // Prevent handling multi-touch events (used for pinch-zoom)
          if (e.touches.length !== 1) {
            e.preventDefault();
            return;
          }

          isPanning = true;
          startPanX = e.touches[0].clientX - translateX;
          startPanY = e.touches[0].clientY - translateY;

          // Store initial touch position
          lastMouseX = e.touches[0].clientX;
          lastMouseY = e.touches[0].clientY;

          e.preventDefault();
        }

        // Pan while dragging
        function pan(e) {
          if (!isPanning) return;

          // Update map position in real-time
          translateX = e.clientX - startPanX;
          translateY = e.clientY - startPanY;

          // Store current mouse position
          lastMouseX = e.clientX;
          lastMouseY = e.clientY;

          // Update transform
          updateMapTransform();

          // Check if we need to load new tiles after significant movement
          if (
            Math.abs(e.clientX - lastMouseX) > 50 ||
            Math.abs(e.clientY - lastMouseY) > 50
          ) {
            updateVisibleTiles();
          }

          e.preventDefault();
        }

        // Pan while dragging (touch)
        function panTouch(e) {
          // Don't handle multi-touch events
          if (!isPanning || e.touches.length !== 1) {
            return;
          }

          // Update map position in real-time
          translateX = e.touches[0].clientX - startPanX;
          translateY = e.touches[0].clientY - startPanY;

          // Store current touch position
          lastMouseX = e.touches[0].clientX;
          lastMouseY = e.touches[0].clientY;

          // Update transform
          updateMapTransform();

          // Check if we need to load new tiles after significant movement
          updateVisibleTiles();

          e.preventDefault();
        }

        // End panning
        function endPan(e) {
          if (!isPanning) return;

          isPanning = false;
          mapCanvas.style.cursor = "move";

          // Update tiles after pan ends
          updateVisibleTiles();
        }

        // Handle clicks
        function handleClick(e) {
          if (isPanning) {
            isPanning = false;
            mapCanvas.style.cursor = "move";
          }
        }

        // Zoom in
        function zoomIn() {
          if (scale < MAX_SCALE) {
            // Show loading indicator
            loadingIndicator.style.display = "block";

            // Get center of viewport
            const centerX = mapContainer.offsetWidth / 2;
            const centerY = mapContainer.offsetHeight / 2;

            // Calculate position on the map
            const mapX = (centerX - translateX) / scale;
            const mapY = (centerY - translateY) / scale;

            // Apply zoom
            scale *= 1.2;
            if (scale > MAX_SCALE) scale = MAX_SCALE;

            // Adjust position to zoom around center
            translateX = centerX - mapX * scale;
            translateY = centerY - mapY * scale;

            // Update transform and tiles
            requestAnimationFrame(() => {
              updateMapTransform();
              updateVisibleTiles();
            });
          }
        }

        // Zoom out
        function zoomOut() {
          if (scale > MIN_SCALE) {
            // Show loading indicator
            loadingIndicator.style.display = "block";

            // Get center of viewport
            const centerX = mapContainer.offsetWidth / 2;
            const centerY = mapContainer.offsetHeight / 2;

            // Calculate position on the map
            const mapX = (centerX - translateX) / scale;
            const mapY = (centerY - translateY) / scale;

            // Apply zoom
            scale *= 0.8;
            if (scale < MIN_SCALE) scale = MIN_SCALE;

            // Adjust position to zoom around center
            translateX = centerX - mapX * scale;
            translateY = centerY - mapY * scale;

            // Update transform and tiles
            requestAnimationFrame(() => {
              updateMapTransform();
              updateVisibleTiles();
            });
          }
        }

        // Reset view
        function resetView() {
          // Reset to initial position
          scale = initialScale;
          translateX =
            mapContainer.offsetWidth / 2 - originalWidth * initialX * scale;
          translateY =
            mapContainer.offsetHeight / 2 - originalHeight * initialY * scale;

          // Update
          requestAnimationFrame(() => {
            updateMapTransform();
            updateVisibleTiles();
          });
        }

        // Update map transform with hardware acceleration if available
        function updateMapTransform() {
          if (hasHardwareAcceleration) {
            mapCanvas.style.transform = `translate3d(${translateX}px, ${translateY}px, 0) scale(${scale})`;
          } else {
            mapCanvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
          }

          // Update debug info
          updateDebugInfo();
        }

        // Update debug information
        function updateDebugInfo() {
          debugInfo.textContent = `Zoom: ${scale.toFixed(
            2
          )}, Tiles: ${loadedTiles}/${totalVisibleTiles} loaded, View: ${Math.round(
            -translateX / scale
          )},${Math.round(-translateY / scale)}`;
        }

        // Debounce function to limit the rate at which a function can fire
        function debounce(func, wait) {
          let timeout;
          return function (...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
          };
        }

        // Throttle function for performance-critical code
        function throttle(func, limit) {
          let inThrottle;
          return function (...args) {
            const context = this;
            if (!inThrottle) {
              func.apply(context, args);
              inThrottle = true;
              setTimeout(() => (inThrottle = false), limit);
            }
          };
        }

        // Handle window resizing
        window.addEventListener(
          "resize",
          debounce(() => {
            // Update tiles on resize
            updateVisibleTiles();
          }, 250)
        );
      });
    </script>
  </body>
</html>
